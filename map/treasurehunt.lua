

local internaltreasure =
{
	["TestTreasure"] =
	{
		{
			--Set piece with the treasure prefab
			treasure_set_piece = "BuriedTreasureLayout",

			--The treasure prefab itself. If treasure_set_piece is set this is the prefab
			--inside the set piece. If treasure_set_piece is not set this prefab will be spawned
			--during worldgen
			treasure_prefab = "buriedtreasure",

			--Set piece with the map prefab, only for the first stage in multi stage treasures
			map_set_piece = "TreasureHunterBoon",

			--currently unused
			map_prefab = "messagebottle",

			--Reference to the loot table for the treasure when it is dug up
			loot = "snaketrap"
		}
	},
	["PirateBank"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "10dubloons",
		}
	},

	["SuperTelescope"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "SuperTelescope",
		}
	},

	["WoodlegsKey1"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "WoodlegsKey1",
		}
	},

	["WoodlegsKey2"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "WoodlegsKey2",
		}
	},

	["WoodlegsKey3"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "WoodlegsKey3",
		}
	},

	["PiratePeanuts"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "1dubloon",
		}
	},
	
	["minerhat"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "minerhat",
		}

	},

	["RandomGem"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "gems",
		}
	},

	
	["DubloonsGem"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "dubloonsandgem",
		}
	},


	["SeamansCarePackage"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "seamanscarepackage",
		}
	},

	["ChickenOfTheSea"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "ChickenOfTheSea",
		}
	},

		["BootyInDaBooty"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "BootyInDaBooty",
		}
	},

		["OneTrueEarring"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "OneTrueEarring",
		}
	},

		["PegLeg"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "PegLeg",
		}
	},

		["VolcanoStaff"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "VolcanoStaff",
		}
	},

		["Gladiator"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "Gladiator",
		}
	},

		["FancyHandyMan"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "FancyHandyMan",
		}
	},

		["LobsterMan"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "LobsterMan",
		}
	},

		["Compass"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "Compass",
		}
	},

		["Scientist"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "Scientist",
		}
	},	

		["Alchemist"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "Alchemist",
		}
	},	

		["Shaman"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "Shaman",
		}
	},	

		["FireBrand"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "FireBrand",
		}
	},

		["SailorsDelight"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "SailorsDelight",
		}
	},		

		["WarShip"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "WarShip",
		}
	},	

		["Desperado"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "Desperado",
		}
	},	

		["JewelThief"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "JewelThief",
		}
	},	

		["AntiqueWarrior"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "AntiqueWarrior",
		}
	},	

		["Yaar"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "Yaar",
		}
	},	

		["GdayMate"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "GdayMate",
		}
	},

		["ToxicAvenger"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "ToxicAvenger",
		}
	},

		["MadBomber"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "MadBomber",
		}
	},

		["FancyAdventurer"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "FancyAdventurer",
		}
	},

		["ThunderBall"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "ThunderBall",
		}
	},

		["TombRaider"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "TombRaider",
		}
	},

		["SteamPunk"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "SteamPunk",
		}
	},

		["CapNCrunch"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "CapNCrunch",
		}
	},

		["AyeAyeCapn"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "AyeAyeCapn",
		}
	},

		["BreakWind"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "BreakWind",
		}
	},

		["Diviner"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "Diviner",
		}
	},

		["GoesComesAround"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "GoesComesAround",
		}
	},

		["GoldGoldGold"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "GoldGoldGold",
		}
	},

		["FirePoker"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "FirePoker",
		}
	},

		["DeadmansTreasure"] =
	{
		{
			treasure_set_piece = "RockSkull",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "DeadmansTreasure",
		}
	},

	["TestMultiStage"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "1dubloon",
		},
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "1dubloon",
		},
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "gems",
		},
	},
	
	["SeaPackageQuest"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "1dubloon",
		},
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "dubloonsandgem",
		},
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "seamanscarepackage",
		},
	},

	["TierQuest"] =
	{
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "seamanscarepackage",
		},
		{
			tier = 1,
		},
		{
			tier = 2,
		},
		{
			tier = 2,
		},
		{
			tier = 3,
		},
	}
}

-- everytime a tier chest is picked, it's removed from this list
local Tiers =
{
	[1] = {
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "1dubloon",
		},
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "slot_blowdart",
		},
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "slot_speargun",
		},
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "slot_obsidian",
		},
	},
	----------------------------------------------------------------------
	[2] = {
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "1dubloon",
		},
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "slot_blowdart",
		},
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "slot_speargun",
		},
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "slot_obsidian",
		},
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "slot_dapper",
		},
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "slot_speed",
		},
			
	},
	----------------------------------------------------------------------
	[3] = {
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "1dubloon",
		},
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "slot_blowdart",
		},
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "slot_speargun",
		},
		{
			treasure_set_piece = "BuriedTreasureLayout",
			treasure_prefab = "buriedtreasure",
			map_prefab = "messagebottle",
			loot = "slot_obsidian",
		},
	},
}

local internalloot =
{
	--[[
	["sample"] =
	{
		--[Optional] container that spawns with the loot in it see prefabs/treasurechest.lua
		--any prefab with a container component should work
		chest = "treasurechest",

		--All items in loot is given when a treasure is dug up	
		loot =
		{
			dubloon = 2,
			redgem = 4
		},

		--'num_random_loot' items are given from random_loot (a weighted table)
		num_random_loot = 1,
		random_loot =
		{
			purplegem = 1,
			orangegem = 1,
			yellowgem = 1,
			greengem = 1,
			redgem = 5,
			bluegem = 5,
		},

		--Every item in chance_loot has a custom chance of being given
		--Possible for nothing or everything to be given
		chance_loot =
		{
			dubloon = 0.25,
			goldnugget = 0.25,
			bluegem = 0.1
		},

		--A custom function used to give items
		custom_lootfn = function(lootlist) end
	},
	--]]
	["snaketrap"] =
	{
		loot =
		{
			snake = 3,
			dubloon = 3,
		},
		random_loot =
		{
			purplegem = 1,
			orangegem = 1,
			yellowgem = 1,
			greengem = 1,
			redgem = 5,
			bluegem = 5,
		},
	},

	["1dubloon"] =
	{
		loot =
		{
			dubloon = 1
		}
	},
	
	["3dubloons"] =
	{
		loot =
		{
			dubloon = 3
		}
	},
	
	["10dubloons"] =
	{
		loot =
		{
			dubloon = 10
		}
	},

	["SuperTelescope"] =
	{
		loot =
		{
			supertelescope = 1,
			dubloon = 5,
			spear_poison = 1,
			boat_lantern = 1,
		},

		random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

	},

	--Took the actual keys out of these now that they're granted in other ways. 
	--Don't want to remove the loot tables incase people have saved worlds with these loots set.

	["WoodlegsKey1"] =
	{
		loot =
		{
			dubloon = 10,
		}
	},

	["WoodlegsKey2"] =
	{
		loot =
		{
			dubloon = 10,
		}
	},

	["WoodlegsKey3"] =
	{
		loot =
		{
			dubloon = 10,
		}
	},

	["minerhat"] =
	{
		loot =
		{
			minerhat = 1,
			dubloon = 5,
			obsidianaxe =1,
		},

		random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

	},

	["seamanscarepackage"] =
	{
		chest = "pandoraschest",
		loot =
		{
			dubloon = 5,
			telescope = 1,
			armor_lifejacket = 1,
			captainhat = 1
		},

		random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

	},

	["gems"] =
	{
		chest = "treasurechest",
		loot =
		{
			goldnugget = 3,
		},

		random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

			chance_loot =
		{
			purplegem = .5,
			orangegem = .25,
			yellowgem = .25,
			greengem = .25
		},
	},

	["dubloonsandgem"] =
	{
		loot =
		{
			dubloon = 5
		},
		random_loot =
		{
			purplegem = 1,
			redgem = 5,
			bluegem = 5,
		}
	},


	["ChickenOfTheSea"] =
	{
		loot =
		{
			dubloon = 5,
			tunacan = 5,
		},
	
		random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

		chance_loot =
		{
			purplegem = .1,
			redgem = .25,
			bluegem = .25,
		}

    },
-------------------------------------------------------DAN ADDED FROM HERE
["BootyInDaBooty"] =
	{
		loot =
		{
			dubloon = 5,
			piratepack = 1,
		},
	
		random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

		chance_loot =
		{
			purplegem = .1,
			redgem = .25,
			bluegem = .25,
		}

	},

["OneTrueEarring"] =
	{
		loot =
		{
			earring = 1,
		},
	
		random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},
		chance_loot =
		{
			purplegem = .1,
			redgem = .25,
			bluegem = .25,
		}

	},

["PegLeg"] =
	{
		loot =
		{
			dubloon = 2,
			peg_leg = 1,
		},
	
		random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

		chance_loot =
		{
			purplegem = .1,
			redgem = .25,
			bluegem = .25,
		}

	},

["VolcanoStaff"] =
	{
		loot =
		{
			dubloon = 6,
			volcanostaff = 1,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

		chance_loot =
		{
			purplegem = .1,
			redgem = .25,
			bluegem = .25,
		}

	},

["Gladiator"] =
	{
		loot =
		{
			dubloon = 2,
			footballhat = 1,
			spear = 1,
			armorseashell= 1,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

		chance_loot =
		{
			purplegem = .1,
			redgem = .25,
			bluegem = .25,
		}

	},

["FancyHandyMan"] =
	{
		loot =
		{
			dubloon = 1,
			goldenaxe = 1,
			goldenshovel = 1,
			goldenpickaxe= 1,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

		chance_loot =
		{
			purplegem = .1,
			redgem = .25,
			bluegem = .25,
		}

	},

["LobsterMan"] =
	{
		loot =
		{
			dubloon = 4,
			boat_lantern = 1,
			seatrap = 1,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

		chance_loot =
		{
			purplegem = .1,
			redgem = .25,
			bluegem = .25,
		}

	},

["Compass"] =
	{
		loot =
		{
			dubloon = 3,
			compass = 1,
			boneshard = 2,
			messagebottleempty = 1,
			sand = 1,
		},
	
		random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		}

	},

["Scientist"] =
	{
		loot =
		{
			dubloon = 3,
			transistor =1,
			gunpowder =3,
			heatrock = 1,
		},
	
		random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

		chance_loot =
		{
			purplegem = .1,
			redgem = .25,
			bluegem = .25,
		}

	},

["Alchemist"] =
	{
		loot =
		{
			dubloon = 2,
			antivenom =1,
			healingsalve =3,
			blowdart_sleep = 2,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

		chance_loot =
		{
			purplegem = .1,
			redgem = .25,
			bluegem = .25,
		}

	},

["Shaman"] =
	{
		loot =
		{
			dubloon = 1,
			nightsword =1,
			amulet =1,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

		chance_loot =
		{
			purplegem = .1,
			redgem = .25,
			bluegem = .25,
		}

	},

["FireBrand"] =
	{
		loot =
		{
			dubloon = 2,
			obsidianaxe =1,
			gunpowder =2,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

		chance_loot =
		{
			purplegem = .1,
			redgem = .25,
			bluegem = .25,
		}

	},

["SailorsDelight"] =
	{
		loot =
		{
			dubloon = 4,
			clothsail =1,
			boatrepairkit =1,
			boat_lantern =1,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

		chance_loot =
		{
			purplegem = .1,
			redgem = .25,
			bluegem = .25,
		}

	},

["WarShip"] =
	{
		loot =
		{
			dubloon = 3,
			coconade =3,
			boatcannon =1,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

		chance_loot =
		{
			purplegem = .1,
			redgem = .25,
			bluegem = .25,
		}

	},

["Desperado"] =
	{
		loot =
		{
			dubloon = 1,
			snakeskinhat =1,
			armor_snakeskin =1,
			spear_launcher = 2,
			spear = 1,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

		chance_loot =
		{
			purplegem = .1,
			redgem = .25,
			bluegem = .25,
		}

	},

	["JewelThief"] =
	{
		loot =
		{
			dubloon = 5,
			goldnugget =6,
			purplegem =2,
			redgem = 4,
			bluegem = 3,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		}

	},

	["AntiqueWarrior"] =
	{
		loot =
		{
			dubloon = 5,
			ruins_bat =1,
			ruinshat =1,
			armorruins = 1,
			bluegem = 2,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		}


	},

	["Yaar"] =
	{
		loot =
		{
			dubloon = 1,
			telescope =1,
			piratehat =1,
			boatcannon = 1,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

		chance_loot =
		{
			purplegem = .1,
			redgem = .25,
			bluegem = .25,
		}

	},

	["GdayMate"] =
	{
		loot =
		{
			dubloon = 3,
			boomerang =1,
			snakeskin =3,
			strawhat = 1,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

		chance_loot =
		{
			purplegem = .1,
			redgem = .25,
			bluegem = .25,
		}

	},
	["ToxicAvenger"] =
	{
		loot =
		{
			dubloon = 1,
			gashat =1,
			venomgland =3,
			spear_poison = 1,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

		chance_loot =
		{
			purplegem = .1,
			redgem = .25,
			bluegem = .25,
		}

	},

	["MadBomber"] =
	{
		loot =
		{
			dubloon = 2,
			coconade =2,
			obsidiancoconade =1,
			gunpowder = 2,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

		chance_loot =
		{
			purplegem = .1,
			redgem = .25,
			bluegem = .25,
		}

	},

	["FancyAdventurer"] =
	{
		loot =
		{
			dubloon = 4,
			goldenmachete =1,
			tophat =1,
			rope = 3,
			telescope = 1,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		}



	},

	["ThunderBall"] =
	{
		loot =
		{
			dubloon = 6,
			spear_launcher = 2,
			spear = 1,
			blubbersuit =1,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

		chance_loot =
		{
			purplegem = .1,
			redgem = .25,
			bluegem = .25,
		}

	},

	["TombRaider"] =
	{
		loot =
		{
			dubloon = 4,
			boneshard =3,
			nightmarefuel =4,
			purplegem = 2,
			goldnugget = 3,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		}


	},

	["SteamPunk"] =
	{
		loot =
		{
			dubloon = 1,
			gears =4,
			transistor =2,
			telescope= 1,
			goldnugget = 2,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		}


	},

	["CapNCrunch"] =
	{
		loot =
		{
			dubloon = 4,
			piratehat =1,
			boatcannon =1,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

		chance_loot =
		{
			purplegem = .1,
			redgem = .25,
			bluegem = .25,
		}

	},

	["AyeAyeCapn"] =
	{
		loot =
		{
			dubloon = 1,
			captainhat =1,
			armor_lifejacket =1,
			tunacan =1,
			trawlnet =1,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		}



	},

	["BreakWind"] =
	{
		loot =
		{
			dubloon = 4,
			armor_windbreaker = 1,
			obsidianmachete =1,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

		chance_loot =
		{
			purplegem = .1,
			redgem = .25,
			bluegem = .25,
		}

	},

		["Diviner"] =
	{
		loot =
		{
			dubloon = 4,
			diviningrod =1,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

		chance_loot =
		{
			purplegem = .1,
			redgem = .25,
			bluegem = .25,
		}

	},

		["GoesComesAround"] =
	{
		loot =
		{
			dubloon = 3,
			boomerang =1,
			trap_teeth =2,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

		chance_loot =
		{
			purplegem = .1,
			redgem = .25,
			bluegem = .25,
		}

	},

		["GoldGoldGold"] =
	{
		loot =
		{
			dubloon = 6,
			goldnugget = 5,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

		chance_loot =
		{
			purplegem = .1,
			redgem = .25,
			bluegem = .25,
		}

	},

		["FirePoker"] =
	{
		loot =
		{
			dubloon = 2,
			spear_obsidian = 1,
			armorobsidian = 1,
		},
	
	random_loot =
		{
			redgem = 1,
			bluegem = 1,
			papyrus = 1,
			tunacan = 1,
			blueprint = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

		chance_loot =
		{
			purplegem = .1,
			redgem = .25,
			bluegem = .25,
		}

	},

		["DeadmansTreasure"] =
	{
		loot =
		{
			dubloon = 4,
			boatrepairkit = 1,
			goldenmachete = 1,
			obsidiancoconade = 3,
		},
	
	random_loot =
		{
			fabric = 1,
			papyrus = 1,
			tunacan = 1,
			goldnugget = 1,
			gears = 1,
			purplegem = 1,
			redgem =1,
			bluegem =1,
			rope =1,

		},

		chance_loot =
		{
			harpoon = .1,
			boatcannon = .01,
			rope = .25,
		}

	},

-------------------------------GOOD LIST

	["staydry"] = 
	{
		loot = 
		{
			palmleaf_umbrella = 1,
			armor_snakeskin = 1,
			snakeskinhat = 1,
		},
	},

	["gears"] = 
	{
		loot = 
		{
			gears = 5,
			
		},
	},

	["cooloff"] = 
	{
		loot = 
		{
			ice = 3,
			hawaiianshirt = 1,
			umbrella = 1,
		},
	},

	["birders"] = 
	{
		loot = 
		{
			birdtrap = 1,
			featherhat = 1,
			seeds = 4,
		},
	},

	["slot_anotherspin"] = 
	{
		loot = 
		{
			dubloon = 1,
		},
	},

	["slot_goldy"] = 
	{
		loot = 
		{
			goldnugget = 5,
		},
	},
	
	["slot_honeypot"] = 
	{
		loot = 
		{
			beehat = 1,
			bandage = 1,
			honey = 5,
		},
	},

	["slot_warrior1"] = 
	{
		loot = 
		{
			footballhat = 1,
			armorwood = 1,
			spear = 1,
		},
	},

	["slot_warrior2"] = 
	{
		loot = 
		{
			armormarble = 1,
			hambat = 1,
			blowdart_pipe = 1,
		},
	},

	["slot_warrior3"] = 
	{
		loot = 
		{
			trap_teeth = 1,
			armorgrass = 1,
			boomerang = 1,
		},
	},

	["slot_warrior4"] = 
	{
		loot = 
		{
			spear_launcher = 1,
			spear_poison = 1,
			armorseashell = 1,
			coconade= 1,
		},
	},

	["slot_scientist"] = 
	{
		loot = 
		{
			transistor = 3,
			heatrock = 1,
			gunpowder= 3,
		},
	},

	["slot_walker"] = 
	{
		loot = 
		{
			cane = 1,
			goldnugget= 3,
		},
	},

	["slot_gemmy"] = 
	{
		loot = 
		{
			redgem = 3,
			bluegem= 3,
		},
	},

	["slot_bestgem"] = 
	{
		loot = 
		{
			purplegem = 3,
		},
	},

	["slot_lifegiver"] = 
	{
		loot = 
		{
			amulet = 1,
			goldnugget = 3,
		},
	},

	["slot_chilledamulet"] = 
	{
		loot = 
		{
			blueamulet = 1,
			goldnugget = 3,
		},
	},

	["slot_icestaff"] = 
	{
		loot = 
		{
			icestaff = 1,
			goldnugget = 3,
		},
	},

	["slot_firestaff"] = 
	{
		loot = 
		{
			firestaff = 1,
			goldnugget = 3,
		},
	},

	["slot_coolasice"] = 
	{
		loot = 
		{
			icehat = 1,
			-- tropicalfan = 1,
			palmleaf_umbrella = 1,
		},
	},

	["slot_gunpowder"] = 
	{
		loot = 
		{
			gunpowder = 5,
		},
	},

	["slot_darty"] = 
	{
		loot = 
		{
			blowdart_pipe = 1,
			blowdart_sleep = 1,
			blowdart_fire = 1,
		},
	},

	["slot_firedart"] = 
	{
		loot = 
		{
			blowdart_fire = 3,
			goldnugget = 3,
		},
	},

	["slot_sleepdart"] = 
	{
		loot = 
		{
			blowdart_sleep = 3,
			goldnugget = 3,
		},
	},

	["slot_blowdart"] = 
	{
		loot = 
		{
			blowdart_pipe = 3,
			goldnugget = 3,
		},
	},

	["slot_speargun"] = 
	{
		loot = 
		{
			spear_launcher = 1,
			spear = 1,
			goldnugget = 3,
		},
	},


	["slot_dapper"] = 
	{
		loot = 
		{
			cane = 1,
			goldnugget = 3,
			tophat = 1,
		},
	},

	["slot_speed"] = 
	{
		loot = 
		{
			yellowamulet = 1,
			nightmarefuel = 3,
			goldnugget = 3,
		},
	},

	["slot_coconades"] = 
	{
		loot = 
		{
			coconade= 3,
			goldnugget = 3,
		},
	},

	["slot_obsidian"] = 
	{
		loot = 
		{
			obsidian= 5,
		},
	},

	["slot_thuleciteclub"] = 
	{
		loot = 
		{
			ruins_bat= 1,
			goldnugget = 3,
		},
	},

	["slot_thulecitesuit"] = 
	{
		loot = 
		{
			armorruins= 1,
			goldnugget = 3,
		},
	},

	["slot_ultimatewarrior"] = 
	{
		loot = 
		{
			armorruins= 1,
			ruins_bat= 1,
			ruinshat= 1,
		},
	},

	["slot_goldenaxe"] =
	{
		loot =
		{
			goldenaxe = 1,
			goldnugget = 3,
		},
	},

	["slot_monkeyball"] =
	{
		loot = 
		{
			monkeyball = 1,
			cave_banana = 2,
		},
	},


---------------------------------------OK LIST

	["firestarter"] = 
	{
		loot = 
		{
			log = 2,
			-- twigs = 1,
			cutgrass = 3,
		},
	},

	["geologist"] = 
	{
		loot = 
		{
			rocks = 1,
			goldnugget = 1,
			obsidian = 1,
		},
	},

	["3cutgrass"] =
	{
		loot =
		{
			cutgrass = 5,
		},
	},	

	["3logs"] =
	{
		loot =
		{
			log = 3,
		},
	},

	["3twigs"] =
	{
		loot =
		{
			twigs = 3,
		},
	},

	["slot_torched"] =
	{
		loot =
		{
			torch = 1,
			charcoal = 2,
			ash = 2,
		},
	},

	["slot_jelly"] =
	{
		loot =
		{
			jellyfish_dead = 3,
		},
	},

	["slot_handyman"] =
	{
		loot =
		{
			axe = 1,
			hammer = 1,
			shovel = 1,
		},
	},

	["slot_poop"] =
	{
		loot =
		{
			poop = 5,
		},
	},

	["slot_berry"] =
	{
		loot =
		{
			berries = 5,
		},
	},

	["slot_limpets"] =
	{
		loot =
		{
			limpets = 5,
		},
	},

	["slot_seafoodsurprise"] =
	{
		loot =
		{
			limpets = 2,
			jellyfish_dead = 1,
			tropical_fish = 2,
			fish_med = 1,
		},
	},

	["slot_bushy"] =
	{
		loot =
		{
			berries = 3,
			dug_berrybush2 = 1, --cut down from 3
		},
	},


	["slot_bamboozled"] =
	{
		loot =
		{
			dug_bambootree = 1,
			bamboo = 3,
		},
	},

	["slot_grassy"] =
	{
		loot =
		{
			trap = 1,
			cutgrass = 3,
			strawhat = 1,
		},
	},

	["slot_prettyflowers"] =
	{
		loot =
		{
			petals = 5,
			flowerhat = 1,
		},
	},

	["slot_witchcraft"] =
	{
		loot =
		{
			flower_evil = 5,
			red_cap= 1,
			green_cap = 1,
			blue_cap = 1,
		},
	},

	["slot_bugexpert"] =
	{
		loot =
		{
			bugnet = 1,
			fireflies = 3,
			butterfly = 3,
		},
	},

	["slot_flinty"] =
	{
		loot =
		{
			flint = 5,
		},
	},

	["slot_fibre"] =
	{
		loot =
		{
			cave_banana = 1,
			dragonfruit = 1,
			watermelon = 1,
		},
	},

	["slot_drumstick"] =
	{
		loot =
		{
			drumstick = 3,
		},
	},

	["slot_fisherman"] =
	{
		loot =
		{
			fishingrod = 1,
			fish_med = 3,
			tropical_fish = 3,
		},
	},

    ["slot_bonesharded"] =
	{
		loot =
		{
			hammer = 1,
			skeleton = 3,
		},
	},

    ["slot_jerky"] =
	{
		loot =
		{
			meat_dried = 3,
		},
	},

    ["slot_coconutty"] =
	{
		loot =
		{
			coconut = 5,
		},
	},

	["slot_camper"] =
	{
		loot =
		{
			heatrock = 1,
			bedroll_straw = 1,
			meat_dried = 1,
		},
	},

    ["slot_ropey"] =
	{
		loot =
		{
			rope = 5,
		},
	},

  	["slot_tailor"] =
	{
		loot =
		{
			sewing_kit = 1,
			fabric= 3,
			tophat = 1,
		},
	},

	["slot_spiderboon"] =
	{
		loot =
		{
			spidergland = 2,
			silk = 5,
			monstermeat = 3,
		},
	},



--------------------------------------BAD LIST
	["slot_spiderattack"] =
	{
		loot =
		{
			spider = 3,
		},
	},

  	["slot_mosquitoattack"] =
	{
		loot =
		{
			mosquito_poison= 5,
		},
	},

  	["slot_snakeattack"] =
	{
		loot =
		{
			snake = 3,
		},
	},

	  	["slot_monkeysurprise"] =
	{
		loot =
		{
			primeape = 2,
		},
	},

		["slot_poisonsnakes"] =
	{
		loot =
		{
			snake_poison = 2,
		},
	},

		["slot_hounds"] =
	{
		loot = 
		{
			hound = 2,
		},
	},

}

local TreasureList = {}
local TreasureLootList = {}

function AddTreasure(name, data)
	TreasureList[name] = data
end

function AddTreasureLoot(name, data)
	TreasureLootList[name] = data
end

for name, data in pairs(internaltreasure) do
	AddTreasure(name, data)
end

for name, data in pairs(internalloot) do
	AddTreasureLoot(name, data)
end

local function GetTierLootTable(tier)
	-- TODO: yank it out!
	print("GetTierLootTable", tier, #Tiers[tier])
	return table.remove(Tiers[tier], math.random(1, #Tiers[tier]))
end

function GetTreasureDefinitionTable()
	return TreasureList
end

function GetTreasureDefinition(name)
	return TreasureList[name]
end

function GetTreasureLootDefinitionTable()
	return TreasureLootList
end

function GetTreasureLootDefinition(name)
	return TreasureLootList[name]
end

function ApplyModsToTreasure()
	for name, data in pairs(TreasureList) do
		local modfns = ModManager:GetPostInitFns("TreasurePreInit", name)
		for i,modfn in ipairs(modfns) do
			print("Applying mod to treasure ", name)
			modfn(data)
		end
	end
end

function ApplyModsToTreasureLoot()
	for name, data in pairs(TreasureLootList) do
		local modfns = ModManager:GetPostInitFns("TreasureLootPreInit", name)
		for i,modfn in ipairs(modfns) do
			print("Applying mod to treasure loot ", name)
			modfn(data)
		end
	end
end

local function GetTreasureLoot(loots)
	local lootlist = {}
	if loots then
		if loots.loot then
			for prefab, n in pairs(loots.loot) do
				if lootlist[prefab] == nil then
					lootlist[prefab] = 0
				end
				lootlist[prefab] = lootlist[prefab] + n
			end
		end
		if loots.random_loot then
			for i = 1, (loots.num_random_loot or 1), 1 do
				local prefab = weighted_random_choice(loots.random_loot)
				if prefab then
					if lootlist[prefab] == nil then
						lootlist[prefab] = 0
					end
					lootlist[prefab] = lootlist[prefab] + 1
				end
			end
		end
		if loots.chance_loot then
			for prefab, chance in pairs(loots.chance_loot) do
				if math.random() < chance then
					if lootlist[prefab] == nil then
						lootlist[prefab] = 0
					end
					lootlist[prefab] = lootlist[prefab] + 1
				end
			end
		end
		if loots.custom_lootfn then
			loots.custom_lootfn(lootlist)
		end
	end
	return lootlist
end

function GetTreasureLootList(name)
	return GetTreasureLoot(GetTreasureLootDefinition(name))
end

function SpawnTreasureLoot(name, lootdropper, pt, nexttreasure)
	if name and lootdropper ~= nil then
		if not pt then
			pt = Point(lootdropper.inst.Transform:GetWorldPosition())
		end

		if nexttreasure and nexttreasure ~= nil then
			--Spawn a bottle to the next treasure
			local bottle = inst.components.lootdropper:SpawnLootPrefab("messagebottle")
			bottle.treasure = nexttreasure
			--bottle:OnDrop() Handled by lootdropper/inventoryitem  now 
		end

		local player = GetPlayer()
		local loots = GetTreasureLootDefinition(name)
		local lootprefabs = GetTreasureLoot(loots)
		for p, n in pairs(lootprefabs) do
			for i = 1, n, 1 do
				local loot = lootdropper:SpawnLootPrefab(p, pt)
				assert(loot, "can't spawn "..tostring(p))
				if not loot.components.inventoryitem then
					-- attacker?
					if loot.components.combat then
						loot.components.combat:SuggestTarget(player)
					end
				end
			end
		end
	end
end

function SpawnTreasureChest(name, lootdropper, pt, nexttreasure)
	local loots = GetTreasureLootDefinition(name)
	if loots then
		local chest = SpawnPrefab(loots.chest or "treasurechest")
		if chest then
			if not pt then
				pt = Point(lootdropper.inst.Transform:GetWorldPosition())
			end

			chest.Transform:SetPosition(pt.x, pt.y, pt.z)
			SpawnPrefab("collapse_small").Transform:SetPosition(pt.x, pt.y, pt.z)

			if chest.components.container then
				if nexttreasure and nexttreasure ~= nil then
					--Spawn a bottle to the next treasure
					local bottle = SpawnPrefab("messagebottle")
					bottle.treasure = nexttreasure
					chest.components.container:GiveItem(bottle, nil, nil, true, false)
				end

				local player = GetPlayer()
				local lootprefabs = GetTreasureLoot(loots)
				for p, n in pairs(lootprefabs) do
					for i = 1, n, 1 do
						local loot = SpawnPrefab(p)
						if loot.components.inventoryitem and not loot.components.container then
							chest.components.container:GiveItem(loot, nil, nil, true, false)
						else
							local pos = Vector3(pt.x, pt.y, pt.z)
							local start_angle = math.random()*PI*2
							local rad = 1
							if chest.Physics then
								rad = rad + chest.Physics:GetRadius()
							end
							local offset = FindWalkableOffset(pos, start_angle, rad, 8, false)
							if offset == nil then
								return
							end

							pos = pos + offset

							loot.Transform:SetPosition(pos.x, pos.y, pos.z)
							-- attacker?
							if loot.components.combat then
								loot.components.combat:SuggestTarget(player)
							end
						end
					end
				end
			else
				SpawnTreasureLoot(name, lootdropper, pt)
			end
		end
	end
end

require("spawnutil")

function WorldGenPlaceTreasures(tasks, entitiesOut, width, height, min_id, level)
	print("WorldGenPlaceTreasures called!", tasks, entitiesOut, width, height, min_id)

	local obj_layout = require("map/object_layout")

	local function AllStagesPlaced(treasure, stageCount)
		local ret = true
		for i = 1, stageCount, 1 do
			if treasure.stages[i] == nil then
				print("Not all stages placed, missing ", i)
				ret = false
			end
		end
		return ret
	end

	local function GetRandomNode(task, layout, restrict_to)
		local is_entrance = function(room)
			-- return true if the room is an entrance
			--print("is_entrance", tostring(room.data.entrance))
			return room.data.entrance ~= nil and room.data.entrance == true
		end
		local is_background_ok = function(room, restrict_to)
			-- return true if the piece is not backround restricted, or if it is but we are on a background
			--print("is_background_ok", tostring(restrict_to), tostring(room.data.type))
			return restrict_to ~= "background" or room.data.type == "background"
		end
		local is_water_ok = function(room, layout)
			local water_room = room.data.type == "water" or WorldSim:IsWater(room.data.value)
			local water_layout = layout and layout.water == true
			--print("is_water_ok", tostring(water_room), tostring(water_layout))
			return (water_room and water_layout) or (not water_room and not water_layout)
		end
		local isnt_blank = function(room)
			--print("isnt_blank", tostring(room.data.type))
			return room.data.type ~= "blank"
		end

		local choicekeys = shuffledKeys(task.nodes)
		for i, choicekey in ipairs(choicekeys) do
			local node = task.nodes[choicekey]
			if node.data.value ~= GROUND.IMPASSABLE and not is_entrance(node) and is_background_ok(node, restrict_to) and isnt_blank(node) and is_water_ok(node, layout) then
				return node
			end
		end
	end

	local function GetRandomTaskNode(tasks, layout, restrict_to)
		local taskkeys = shuffledKeys(tasks)
		local node = nil
		local j = 1
		while j < #taskkeys and node == nil do
			node = GetRandomNode(tasks[taskkeys[j]], layout, restrict_to)
			j = j + 1
		end

		return node
	end

	local function GetRandomTaskNodeFromList(tasks, layout, choicetasks)
		if choicetasks then
			local choices = shuffleArray(choicetasks)
			for i, task in ipairs(choices) do
				if tasks[task] then
					local node = GetRandomNode(tasks[task], layout)
					if node then
						return node
					end
				end
			end
		end
		return GetRandomTaskNode(tasks, layout)
	end

	local function GetSetpiecePosition(nodeid, layout, prefabs)
		print("GetPointsForSite", nodeid)
		local layoutsize = math.max(GetLayoutRadius(layout, prefabs), 1)
		local points_x, points_y, points_type = WorldSim:GetPointsForSite(nodeid)
		if layout.water and layout.water == true then
			for i = 1, #points_x, 1 do
				if IsSurroundedByWater(points_x[i], points_y[i], layoutsize) then
					return points_x[i], points_y[i]
				end
			end
		else
			for i = 1, #points_x, 1 do
				if not IsCloseToWater(points_x[i], points_y[i], layoutsize) then
					return points_x[i], points_y[i]
				end
			end
		end
		return nil, nil
	end

	local function GetPrefabPosition(nodeid, radius)
		print("GetPointsForSite", nodeid)
		local points_x, points_y, points_type = WorldSim:GetPointsForSite(nodeid)
		for i = 1, #points_x, 1 do
			if not IsCloseToWater(points_x[i], points_y[i], radius) then
				return points_x[i], points_y[i]
			end
		end
	end

	local function VerifyTreasure(level)
		for name, _ in pairs(self.treasures) do
			local def = GetTreasureDefinition(name)
			assert(def ~= nil, "Treasure: '"..name.."' does not exist!, Check treasures in shipwrecked.lua")
		end
		for i = 1, #self.optional_treasures, 1 do
			local def = GetTreasureDefinition(self.optional_treasures[i])
			assert(def ~= nil, "Treasure: '"..self.optional_treasures[i].."' does not exist!, Check optional_treasures in shipwrecked.lua")
		end
		for i = 1, #self.random_treasures, 1 do
			local def = GetTreasureDefinition(self.random_treasures[i])
			assert(def ~= nil, "Treasure: '"..self.random_treasures[i].."' does not exist!, Check random_treasures in shipwrecked.lua")
		end
		for i = 1, #self.required_treasures, 1 do
			local def = GetTreasureDefinition(self.required_treasures[i])
			assert(def ~= nil, "Treasure: '"..self.required_treasures[i].."' does not exist!, Check required_treasures in shipwrecked.lua")
		end
	end

	local treasureid = 2400
	local function AddTreasureToList(treasure_list, name, treasuretasks, maptasks, nodeid)
		--print("Add treasure", name, treasureid, nodeid)
		treasure_list[treasureid] = {}
		treasure_list[treasureid].name = name
		treasure_list[treasureid].treasuretasks = treasuretasks
		treasure_list[treasureid].maptasks = maptasks
		treasure_list[treasureid].stages = {}

		local treasuredef = GetTreasureDefinition(name)
		for i, stagedef in ipairs(treasuredef) do
			treasure_list[treasureid].stages[i] = {}
		end

		if nodeid then
			treasure_list[treasureid].stages[1].nodeid = nodeid
		end

		treasureid = treasureid + 1
	end

	local function BuildTreasureListFromTasks(treasure_list, tasks)
		for taskid, task in pairs(tasks) do
			local nodes = task:GetNodes(true)
			for nodeid, node in pairs(nodes) do
				if node.data.terrain_contents then
					if node.data.terrain_contents.treasure_data ~= nil then
						for id, treasure_data in pairs(node.data.terrain_contents.treasure_data) do
							if treasure_list[id] == nil then
								--print("Add treasure", treasure_data.name, id)
								treasure_list[id] = {}
								treasure_list[id].name = treasure_data.name
								treasure_list[id].stages = {}
							end
							assert(treasure_list[id].name == treasure_data.name)
							treasure_list[id].stages[treasure_data.stage] = {nodeid = node.id}
						end
					end
					if node.data.terrain_contents.treasures ~= nil then
						for i, treasure_data in ipairs(node.data.terrain_contents.treasures) do
							AddTreasureToList(treasure_list, treasure_data.name, nil, nil, node.id)
						end
					end
				end
			end
		end
	end

	local function BuildTreasureListFromLevel(treasure_list, tasks, level)
		if level.treasures then
			for name, data in pairs(level.treasures) do
				for i = 1, data.count or 1, 1 do
					AddTreasureToList(treasure_list, name, data.treasuretasks, data.maptasks)
				end
			end
		end

		if level.optional_treasures and level.numoptional_treasures and level.numoptional_treasures > 0 then
			local choicekeys = shuffledKeys(level.optional_treasures)
			for i = 1, level.numoptional_treasures, 1 do
				AddTreasureToList(treasure_list, level.optional_treasures[choicekeys[i]])
			end
		end

		if level.random_treasures and level.numrandom_treasures and level.numrandom_treasures > 0 then
			for i = 1, level.numrandom_treasures, 1 do
				AddTreasureToList(treasure_list, level.random_treasures[math.random(1, #level.random_treasures)])
			end
		end
	end

	print("Building treasure defs...")
	local treasure_list = {}
	local treasure_prefabs = {}
	local map_prefabs = {}
	local prefab_list = {}
	local add_fn = {
		fn=function(prefab, points_x, points_y, idx, entitiesOut, width, height, prefab_list, prefab_data, rand_offset)
			AddEntity(prefab, points_x[idx], points_y[idx], entitiesOut, width, height, prefab_list, prefab_data, rand_offset)
		end,
		args={entitiesOut=entitiesOut, width=width, height=height, rand_offset = true, debug_prefab_list=prefab_list}
	}

	BuildTreasureListFromTasks(treasure_list, tasks)
	BuildTreasureListFromLevel(treasure_list, tasks, level)

	ApplyModsToTreasure()

	local function PlaceTreasure(treasureid, treasure)
		--print("Placing ", treasureid, treasure.name)
		local treasuredef = GetTreasureDefinition(treasure.name)
		if treasuredef and AllStagesPlaced(treasure, #treasuredef) then
			local first_stage = math.huge
			for stageid, stage in pairs(treasure.stages) do
				local stagedef = treasuredef[stageid]

				if stageid < first_stage then
					first_stage = stageid
				end

				-- random tier stuff
				if stagedef.tier then
					stagedef = GetTierLootTable(stagedef.tier)
				end

				if stagedef.treasure_set_piece then
					--print("Treasure set piece ", stagedef.treasure_set_piece)
					local layout = obj_layout.LayoutForDefinition(stagedef.treasure_set_piece)
					local prefabs = obj_layout.ConvertLayoutToEntitylist(layout)

					for i,p in ipairs(prefabs) do
						if p.prefab == stagedef.treasure_prefab then
							--print("Treasure prefab", p.prefab, stagedef.treasure_prefab)
							if p.properties == nil then
								p.properties = {}
							end
							p.properties.id=min_id
							p.properties.data={treasureid=treasureid, stage=stageid, loot=stagedef.loot}
							min_id = min_id + 1

							stage.prefab = p
							break
						end
					end

					if stage.nodeid == nil then
						stage.nodeid = GetRandomTaskNodeFromList(tasks, layout, treasure.treasuretasks).id
					end
					
					--local lx, ly = GetSetpiecePosition(stage.nodeid, layout, prefabs)
					--obj_layout.ReserveAndPlaceLayout("POSITIONED", layout, prefabs, add_fn, {lx, ly})
					obj_layout.ReserveAndPlaceLayout(stage.nodeid, layout, prefabs, add_fn)
				else
					local treasure_prefab = stagedef.treasure_prefab or "buriedtreasure"
					--print("Treasure prefab ", treasure_prefab)
					local properties = {}
					properties.id = min_id
					properties.data={treasureid=treasureid, stage=stageid, loot=stagedef.loot}
					min_id = min_id + 1

					stage.prefab = {}
					stage.prefab.properties = properties

					if stage.nodeid == nil then
						stage.nodeid = GetRandomTaskNodeFromList(tasks, nil, treasure.treasuretasks).id
					end

					local px, py = GetPrefabPosition(stage.nodeid, 1)
					add_fn.fn(treasure_prefab, {px}, {py}, 1, add_fn.args.entitiesOut, add_fn.args.width, add_fn.args.height, add_fn.args.debug_prefab_list, properties, false)
				end
			end

			--add a map
			local first_stagedef = treasuredef[first_stage]
			if first_stagedef.map_set_piece then
				--print("Map set piece ", first_stagedef.map_set_piece)
				local layout = obj_layout.LayoutForDefinition(first_stagedef.map_set_piece)
				local prefabs = obj_layout.ConvertLayoutToEntitylist(layout)

				for i,p in ipairs(prefabs) do
					if p.prefab == first_stagedef.map_prefab then
						--print("Map prefab ", p.prefab, treasure.stages[first_stage].prefab.properties.id)
						if p.properties == nil then
							p.properties = {}
						end

						p.properties.data={treasure = treasure.stages[first_stage].prefab.properties.id, name=treasure.name}
						break
					end
				end

				if layout and layout.water then
					local checkFn = function(ground) return WorldSim:IsWater(ground) end
					PlaceWaterLayout(layout, prefabs, add_fn, checkFn)
				else
					local node = GetRandomTaskNodeFromList(tasks, layout, treasure.maptasks)
					if node and node.id then
						--local lx, ly = GetSetpiecePosition(node.id, layout, prefabs)
						--obj_layout.ReserveAndPlaceLayout("POSITIONED", layout, prefabs, add_fn, {lx, ly})
						obj_layout.ReserveAndPlaceLayout(node.id, layout, prefabs, add_fn)
					else
						print("Error couldn't find a node for ", first_stagedef.map_set_piece)
					end
				end
			else
				local map_prefab = first_stagedef.map_prefab or "messagebottle"
				--print("Map prefab ", map_prefab, treasure.stages[first_stage].prefab.properties.id)
				map_prefabs[treasureid] = {}
				map_prefabs[treasureid].prefab = map_prefab
				map_prefabs[treasureid].properties = {data={treasure = treasure.stages[first_stage].prefab.properties.id, name=treasure.name}}
			end

			--print("Linking treasure ", treasureid)
			for stageid, stage in pairs(treasure.stages) do
				local p = stage.prefab
				assert(p, "Can't link treasures treasureid: "..tostring(treasureid)..", stageid: "..tostring(stageid))
				assert(p.properties.data.treasureid == treasureid, "Treasure ids don't match! "..tostring(p.properties.data.treasureid)..", "..tostring(treasureid))
				--print(string.format("treasureid %d, stage %d, loot %s", p.properties.data.treasureid, p.properties.data.stage, p.properties.data.loot))

				if treasure.stages[stageid - 1] then
					local prevp = treasure.stages[stageid - 1].prefab
					--print(string.format("Connect prev %d -> %d", prevp.properties.id, p.properties.id))
					p.properties.data.treasureprev = prevp.properties.id
				end
				if treasure.stages[stageid + 1] then
					local nextp = treasure.stages[stageid + 1].prefab
					--print(string.format("Connect next %d -> %d", p.properties.id, nextp.properties.id))
					p.properties.data.treasurenext = nextp.properties.id
				end
			end
		else
			print("Treasure can't be placed ", treasureid, treasure.name)
		end		
	end

	print("Placing treasures...")
	for treasureid, treasure in pairs(treasure_list) do
		PlaceTreasure(treasureid, treasure)
	end

	print("Placing maps...")
	local edge_dist = 24
	local map_count = GetTableSize(map_prefabs)
	local points_x, points_y = GetRandomWaterPoints(function(ground) return WorldSim:IsWater(ground) end, width, height, edge_dist, 2 * map_count + 10)
	local cur_pos = 1
	for treasureid, map in pairs(map_prefabs) do
		add_fn.fn(map.prefab, points_x, points_y, cur_pos, add_fn.args.entitiesOut, add_fn.args.width, add_fn.args.height, add_fn.args.debug_prefab_list, map.properties, false)
		cur_pos = cur_pos + 1
	end

	return true
end
